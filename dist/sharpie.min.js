!function(t,e){"object"==typeof exports&&"object"==typeof module?module.exports=e():"function"==typeof define&&define.amd?define([],e):"object"==typeof exports?exports.Sharpie=e():t.Sharpie=e()}(window,function(){return function(t){var e={};function n(r){if(e[r])return e[r].exports;var a=e[r]={i:r,l:!1,exports:{}};return t[r].call(a.exports,a,a.exports,n),a.l=!0,a.exports}return n.m=t,n.c=e,n.d=function(t,e,r){n.o(t,e)||Object.defineProperty(t,e,{enumerable:!0,get:r})},n.r=function(t){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(t,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(t,"__esModule",{value:!0})},n.t=function(t,e){if(1&e&&(t=n(t)),8&e)return t;if(4&e&&"object"==typeof t&&t&&t.__esModule)return t;var r=Object.create(null);if(n.r(r),Object.defineProperty(r,"default",{enumerable:!0,value:t}),2&e&&"string"!=typeof t)for(var a in t)n.d(r,a,function(e){return t[e]}.bind(null,a));return r},n.n=function(t){var e=t&&t.__esModule?function(){return t.default}:function(){return t};return n.d(e,"a",e),e},n.o=function(t,e){return Object.prototype.hasOwnProperty.call(t,e)},n.p="",n(n.s=1)}([function(t,e,n){"use strict";Object.defineProperty(e,"__esModule",{value:!0}),e._debug=function(){},e._error=function(){},e.defaults=function(t,e){return t?Object.assign({},e,t):Object.assign({},e)},e.identity=function(t){return t},e.sortedInsert=function(t,n){var r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:e.identity,a=r(n);if(0!==t.length){for(var o=0,i=t.length;i-o>1;){var u=o+(i-o>>1),c=r(t[u]);a<c?i=u:o=u}var s=a<=r(t[o])?o:i;t.splice(s,0,n)}else t.push(n)}},function(t,e,n){"use strict";Object.defineProperty(e,"__esModule",{value:!0});var r=n(2);e.clearSelection=r.clearSelection,e.snapUserSelection=r.snapUserSelection,e.watch=r.watch,e.unwatch=r.unwatch;var a=n(3);e.renderHTML=a.render,e.renderToString=a.renderToString},function(t,e,n){"use strict";Object.defineProperty(e,"__esModule",{value:!0});var r=n(0),a=new Map;function o(t,e){var n=!0,r=!1,o=void 0;try{for(var i,u=a.keys()[Symbol.iterator]();!(n=(i=u.next()).done);n=!0){var c=i.value;if(c.contains(e))return a.get(c).get(t)}}catch(t){r=!0,o=t}finally{try{n||null==u.return||u.return()}finally{if(r)throw o}}}function i(t,e){var n=o(t,e.anchorNode);if(n){var a=o(t,e.focusNode);if(a){if(n===a)return n;r._debug("Selection spans multiple watched containers")}else r._debug("Selection ends outside of watched container")}else r._debug("Selection starts outside of watched container")}function u(t){var e=function(t){for(var e=t,n=document.body;e&&e!==n;){if(e.dataset&&e.dataset.hasOwnProperty("sharpieStart"))return e;e=e.parentElement}}(t),n=function(t){for(var e=t;e;){if(e.dataset&&e.dataset.hasOwnProperty("sharpieStart"))return e;e=e.previousElementSibling}}(t),r=n?n.dataset.sharpieEnd:e.dataset.sharpieStart,a=e.dataset.sharpieWarp;return{pos:+r,warp:a?+a:1}}function c(t){var e=u(t.startContainer),n=u(t.endContainer),r=e.pos+t.startOffset*e.warp,a=n.pos+t.endOffset*n.warp;return[Math.floor(r),Math.ceil(a)]}function s(t){var e=window.getSelection(),n=i("select",e);if(n){var a=i("deselect",e);if(e.isCollapsed){r._debug("Firing deselect callbacks");var o=!0,u=!1,s=void 0;try{for(var l,f=(a||[])[Symbol.iterator]();!(o=(l=f.next()).done);o=!0){(0,l.value)(t)}}catch(t){u=!0,s=t}finally{try{o||null==f.return||f.return()}finally{if(u)throw s}}}else for(var d=0;d<e.rangeCount;d++){var p=e.getRangeAt(d);if(p.collapsed)r._debug("Ignoring collapsed range");else{var h=c(p),v=!0,g=!1,y=void 0;try{for(var m,b=n[Symbol.iterator]();!(v=(m=b.next()).done);v=!0){(0,m.value)(h,t)}}catch(t){g=!0,y=t}finally{try{v||null==b.return||b.return()}finally{if(g)throw y}}}}}else r._debug("Ignoring selection due to overflow")}function l(t){return function(e){var n=e.target;if(n.classList.contains("sharpie-annotation")){var a=n.dataset.sharpieId;if(a){if("inferred-"!==a.substr(0,9)){var i=+a;if(i==i){var u=o(t,n);if(u){var c=!0,s=!1,l=void 0;try{for(var f,d=u[Symbol.iterator]();!(c=(f=d.next()).done);c=!0){(0,f.value)(i,e)}}catch(t){s=!0,l=t}finally{try{c||null==d.return||d.return()}finally{if(s)throw l}}}}else r._debug("Could not parse sharpie ID:",a)}}else r._debug("Sharpie ID not set on event target")}}}var f=l("hoverIn"),d=l("hoverOut"),p=l("click"),h=!1;function v(t,e){return t.has(e)||t.set(e,new Set),t.get(e)}e.watch=function(t){h||(window.addEventListener("mouseup",s),window.addEventListener("mouseover",f),window.addEventListener("mouseout",d),window.addEventListener("click",p),h=!0),a.has(t)||a.set(t,new Map);var e=a.get(t),n={click:function(t){return v(e,"click").add(t),n},hoverIn:function(t){return v(e,"hoverIn").add(t),n},hoverOut:function(t){return v(e,"hoverOut").add(t),n},select:function(t){return v(e,"select").add(t),n},deselect:function(t){return v(e,"deselect").add(t),n}};return n},e.unwatch=function(t,e,n){var r=a.get(t);if(!r)return!1;if(n){var o=r.get(e);if(!o)return!1;var i=o.has(n);return o.delete(n),i}if(e){var u=r.has(e);return r.delete(e),u}return a.delete(t),!0},e.clearSelection=function(){if(window.getSelection){var t=window.getSelection();t.empty?t.empty():t.removeAllRanges&&t.removeAllRanges()}},e.snapUserSelection=function(t,e){var n="[data-sharpie-id='".concat(e,"']"),r=t.querySelectorAll(n),a=r[0],o=r[r.length-1],i=function(t){for(var e=t;e.firstChild;)e=e.firstChild;return e}(a),u=function(t){for(var e=t;e.lastChild;)e=e.lastChild;return e}(o),c=document.createRange();c.setStart(i,0),c.setEnd(u,u.textContent.length);var s=window.getSelection();s.removeAllRanges(),s.addRange(c)}},function(t,e,n){"use strict";function r(t){return function(t){if(Array.isArray(t)){for(var e=0,n=new Array(t.length);e<t.length;e++)n[e]=t[e];return n}}(t)||function(t){if(Symbol.iterator in Object(t)||"[object Arguments]"===Object.prototype.toString.call(t))return Array.from(t)}(t)||function(){throw new TypeError("Invalid attempt to spread non-iterable instance")}()}function a(t,e){return function(t){if(Array.isArray(t))return t}(t)||function(t,e){var n=[],r=!0,a=!1,o=void 0;try{for(var i,u=t[Symbol.iterator]();!(r=(i=u.next()).done)&&(n.push(i.value),!e||n.length!==e);r=!0);}catch(t){a=!0,o=t}finally{try{r||null==u.return||u.return()}finally{if(a)throw o}}return n}(t,e)||function(){throw new TypeError("Invalid attempt to destructure non-iterable instance")}()}Object.defineProperty(e,"__esModule",{value:!0});var o=n(0),i=new Set(["address","article","aside","blockquote","details","dialog","dd","div","dl","dt","fieldset","figcaption","figure","footer","form","h1","h2","h3","h4","h5","h6","header","hgroup","hr","li","main","nav","ol","p","pre","section","table","ul"]);function u(t,e){var n=t.annotation.type,r=e.annotation.type,a=t.tagName.toLowerCase(),o=e.tagName.toLowerCase();if("p"===a)return-1;if("p"===o)return 1;if(n!==r){if("highlight"===n)return 1;if("highlight"===r)return-1}return i.has(a)?-1:i.has(o)?1:-1}function c(t,e){return t.start===e.start?t.end<e.end?1:-1:t.start<e.start?-1:1}function s(t,e,n){return{start:t,end:e,type:"markup",meta:{htmlTagName:"p",htmlClassName:n?"auto-para-break":void 0}}}var l={font:"font-family",fontSize:"font-size",color:"color",bgColor:"background-color",opacity:"opacity"};function f(t){var e=Object.keys(t).map(function(e){var n=t[e],r=l[e]||e;return"".concat(r,": ").concat(n)});return e.length?e.join("; ")+";":""}function d(t){var e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"span";return t.meta&&t.meta.htmlTagName?t.meta.htmlTagName.toLowerCase():e.toLowerCase()}function p(t,e,n,r){var o=d(t),i=[],u=function(t){var e=t.format;switch(t.type){case"redaction":return Object.assign({"white-space":"pre-wrap","word-break":"break-word"},e);default:return Object.assign({},e)}}(t);u&&(f(u)&&i.push(["style",f(u)]));t.meta&&t.meta.id&&i.push(["id",t.meta.id]);var c=r.simpleHTML?[]:["sharpie-annotation","sharpie-type-".concat(t.type)];t.meta&&t.meta.htmlClassName&&c.push(t.meta.htmlClassName),c.length&&i.push(["class",c.join(" ")]);var s=r.simpleHTML?"":" ".concat(g(e,n)),l=i.map(function(t){var e=a(t,2),n=e[0],r=e[1];return"".concat(n,'="').concat(r,'"')}).join(" "),p=l?" ".concat(l):"";return"<".concat(o).concat(s).concat(p,">")}function h(t,e){var n=d(t,e);return"</".concat(n,">")}function v(t,e,n){for(var r=(t=t||"").length,a=Math.max(r,e),o=e-r,i=o>>1,u=o-i,c=new Array(a),s=0,l=0;l<i;l++)c[s++]=n;for(var f=0;f<r;f++)c[s++]=t[f];for(var d=0;d<u;d++)c[s++]=n;return c}function g(t,e){return"__metadata_".concat(t,"_").concat(e,"__")}function y(t,e,n){if(null==t)return o._debug("Input missing, bailing out of render"),"";var l=[];(n=o.defaults(n,{autoParagraph:!0,simpleHTML:!1})).autoParagraph&&(o._debug("Generating HTML paragraph break annotations"),l=function(t,e){for(var n=[],r=/\n/g,a=0,o=null;null!==(o=r.exec(t));)n.push(s(a,o.index,!e.simpleHTML)),a=o.index;return n.push(s(a,t.length,!e.simpleHTML)),n}(t,n));var f=new WeakMap,y=new WeakMap;e.forEach(function(t,e){return f.set(t,"".concat(e))}),l.forEach(function(t,e){return f.set(t,"inferred-".concat(e))});for(var m,b,w,S,_=[].concat(r(e),r(l)).sort(c),O=[],M=[],j=[],x=[],k=new Map,T="",C=0;C<=t.length;C++){for(;M.length>0&&M[0].end===C;)for(var L=M[0];O.length>0;){var P=O.shift();T+=h(P.annotation),k.get(g(P.id,P.part)).end=C;for(var I=0;I<M.length;){var A=M[I];if(A.end>C)break;A===P.annotation?M.splice(I,1):I++}if(L===P.annotation)break;P.annotation.end>C&&j.unshift({annotation:P.annotation,id:P.id,part:P.part+1,start:C,end:-1,outputOffsetPos:-1,warp:-1})}for(var E=[];_.length>0&&_[0].start===C;){var N=_.shift();if(N.end<=N.start)o._debug("Ignoring invalid annotation range",N.start,N.end);else{for(var H=d(N),R=-1,D=O.length-1;D>=0;D--)if(m=O[D].annotation,b=N,w=void 0,S=void 0,w=d(m),S=d(b),!(i.has(S)&&!i.has(w)?(o._debug("Forcing inline reopen:",w,"cannot contain",S),0):"redaction"!==b.type||"highlight"!==m.type||(o._debug("Forcing highlight reopen: containing redaction"),0))){R=D;break}for(var F=0;F<=R;F++){var U=O.shift();T+=h(U.annotation),k.get(g(U.id,U.part)).end=C,j.unshift({annotation:U.annotation,id:U.id,part:U.part+1,start:C,end:-1,outputOffsetPos:-1,warp:-1}),F++}var W=1,q=void 0;if("redaction"===N.type){var z=N.end-N.start,G=N.extent?N.extent:Math.max(z,(N.content||"").length);q={redaction:N,output:v(N.content,G,"&nbsp;"),extent:G,cursor:0},W=z/G}y.set(N,W),E.push({annotation:N,tagName:H,redaction:q,part:0})}}for(;j.length>0;){var B=j.shift();E.push({annotation:B.annotation,tagName:d(B.annotation),part:B.part})}for(E.sort(u);E.length>0;){var J=E.shift(),K=J.annotation;0===J.part&&(o.sortedInsert(M,K,function(t){return t.end}),J.redaction&&x.unshift(J.redaction));var Q={annotation:K,id:f.get(K),part:J.part,start:C,end:-1,warp:y.get(K),outputOffsetPos:T.length};T+=p(K,f.get(K),J.part,n);var V=g(Q.id,Q.part);k.has(V)&&o._error("Overwriting node metadata",V),k.set(V,Q),O.unshift(Q)}for(;x.length&&x[0].redaction.end===C;)x.shift();for(var X=0;X<x.length;X++){var Y=x[X],Z=Y.cursor,$=(1+C-Y.redaction.start)/(Y.redaction.end-Y.redaction.start)*Y.extent;Y.cursor=Math.floor($);for(var tt=0===X&&Y.cursor>Z;tt&&Z<Y.cursor;)T+=Y.output[Z++]}0===x.length&&(T+=t[C]||"")}return n.simpleHTML?T:function(t,e){var n=!0,r=!1,o=void 0;try{for(var i,u=e[Symbol.iterator]();!(n=(i=u.next()).done);n=!0){var c=a(i.value,2),s=c[0],l=c[1],f=['data-sharpie-start="'.concat(l.start,'"'),'data-sharpie-end="'.concat(l.end,'"'),'data-sharpie-warp="'.concat(l.warp,'"'),'data-sharpie-id="'.concat(l.id,'"')].join(" "),d=t.substring(0,l.outputOffsetPos),p=t.substring(l.outputOffsetPos).replace(s,f);t=d+p}}catch(t){r=!0,o=t}finally{try{n||null==u.return||u.return()}finally{if(r)throw o}}return t}(T,k)}e.renderToString=y,e.render=function(t,e,n){var r=Date.now(),a=y(e,n);o._debug("Rendered in",Date.now()-r,"ms"),t.innerHTML=a}}])});