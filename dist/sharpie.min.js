!function(t,e){"object"==typeof exports&&"object"==typeof module?module.exports=e():"function"==typeof define&&define.amd?define([],e):"object"==typeof exports?exports.Sharpie=e():t.Sharpie=e()}(window,function(){return function(t){var e={};function r(n){if(e[n])return e[n].exports;var a=e[n]={i:n,l:!1,exports:{}};return t[n].call(a.exports,a,a.exports,r),a.l=!0,a.exports}return r.m=t,r.c=e,r.d=function(t,e,n){r.o(t,e)||Object.defineProperty(t,e,{enumerable:!0,get:n})},r.r=function(t){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(t,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(t,"__esModule",{value:!0})},r.t=function(t,e){if(1&e&&(t=r(t)),8&e)return t;if(4&e&&"object"==typeof t&&t&&t.__esModule)return t;var n=Object.create(null);if(r.r(n),Object.defineProperty(n,"default",{enumerable:!0,value:t}),2&e&&"string"!=typeof t)for(var a in t)r.d(n,a,function(e){return t[e]}.bind(null,a));return n},r.n=function(t){var e=t&&t.__esModule?function(){return t.default}:function(){return t};return r.d(e,"a",e),e},r.o=function(t,e){return Object.prototype.hasOwnProperty.call(t,e)},r.p="",r(r.s=2)}([function(t,e,r){"use strict";Object.defineProperty(e,"__esModule",{value:!0}),e._debug=function(){},e._error=function(){},e.defaults=function(t,e){return t?Object.assign({},e,t):Object.assign({},e)},e.identity=function(t){return t},e.sortedInsert=function(t,r){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:e.identity,a=n(r);if(0!==t.length){for(var o=0,i=t.length;i-o>1;){var u=o+(i-o>>1),f=n(t[u]);a<f?i=u:o=u}var c=a<=n(t[o])?o:i;t.splice(c,0,r)}else t.push(r)}},function(t,e){t.exports=function t(e){if(n(e))return e;if(n(e.ownerDocument))return e.ownerDocument;if(n(e.document))return e.document;if(e.parentNode)return t(e.parentNode);if(e.commonAncestorContainer)return t(e.commonAncestorContainer);if(e.startContainer)return t(e.startContainer);if(e.anchorNode)return t(e.anchorNode)};var r=9;function n(t){return t&&t.nodeType===r}},function(t,e,r){"use strict";Object.defineProperty(e,"__esModule",{value:!0});var n=r(3);e.watch=n.watch,e.unwatch=n.unwatch;var a=r(13);e.renderHTML=a.render,e.renderToString=a.renderToString},function(t,e,r){"use strict";Object.defineProperty(e,"__esModule",{value:!0});var n=r(0),a=(r(4),new Map);function o(t){var e=!0,r=!1,n=void 0;try{for(var o,i=a.keys()[Symbol.iterator]();!(e=(o=i.next()).done);e=!0){var u=o.value;if(u.contains(t))return a.get(u)}}catch(t){r=!0,n=t}finally{try{e||null==i.return||i.return()}finally{if(r)throw n}}}function i(t){var e=function(t){for(var e=t,r=document.body;e&&e!==r;){if(e.dataset&&e.dataset.hasOwnProperty("sharpieStart"))return e;e=e.parentElement}}(t),r=function(t){for(var e=t;e;){if(e.dataset&&e.dataset.hasOwnProperty("sharpieStart"))return e;e=e.previousElementSibling}}(t),n=r?r.dataset.sharpieEnd:e.dataset.sharpieStart,a=e.dataset.sharpieWarp;return{pos:+n,warp:a?+a:1}}function u(t){var e=i(t.startContainer),r=i(t.endContainer),n=e.pos+t.startOffset*e.warp,a=r.pos+t.endOffset*r.warp;return[Math.floor(n),Math.ceil(a)]}function f(){var t=window.getSelection();if(t.isCollapsed)n._debug("Ignoring collapsed selection");else{var e=function(t){var e=o(t.anchorNode);if(e){var r=o(t.focusNode);if(r){if(e===r)return e;n._debug("Selection spans multiple watched containers")}else n._debug("Selection ends outside of watched container")}else n._debug("Selection starts outside of watched container")}(t);if(e)for(var r=0;r<t.rangeCount;r++){var a=t.getRangeAt(r);if(a.collapsed)n._debug("Ignoring collapsed range");else{var i=u(a),f=!0,c=!1,s=void 0;try{for(var d,l=e[Symbol.iterator]();!(f=(d=l.next()).done);f=!0){(0,d.value)(i)}}catch(t){c=!0,s=t}finally{try{f||null==l.return||l.return()}finally{if(c)throw s}}}}else n._debug("Ignoring selection due to overflow")}}var c=!1;e.watch=function(t,e){c||(window.addEventListener("mouseup",f),c=!0),a.has(t)||a.set(t,new Set),a.get(t).add(e)},e.unwatch=function(t,e){if(e){var r=a.get(t);return!!r&&!!r.has(e)&&(r.delete(e),!0)}return!!a.has(t)&&(a.delete(t),!0)}},function(t,e,r){t.exports=r(5)},function(t,e,r){"use strict";e.__esModule=!0,e.fromRange=function(t,e){var r=t.startContainer,n=t.startOffset,a=t.endContainer,i=t.endOffset,u=o.fromNode(r,e),f=o.fromNode(a,e);return{start:u,end:f,startOffset:n,endOffset:i}},e.toRange=function(t,e,r,i,f){var c=(0,n.default)(f),s=o.toNode(t,f);if(null===s)throw m("start");var d=c.createNodeIterator(s,u),l=e-(0,a.default)(d,e);if(s=d.referenceNode,!d.pointerBeforeReferenceNode){if(l>0)throw w("start");l+=s.length}var p=o.toNode(r,f);if(null===p)throw m("end");var h=c.createNodeIterator(p,u),v=i-(0,a.default)(h,i);if(p=h.referenceNode,!h.pointerBeforeReferenceNode){if(v>0)throw w("end");v+=p.length}var g=c.createRange();return g.setStart(s,l),g.setEnd(p,v),g;function m(t){var e=new Error("The "+t+" node was not found.");return e.name="NotFoundError",e}function w(t){var e=new Error("There is no text at the requested "+t+" offset.");return e.name="IndexSizeError",e}};var n=i(r(1)),a=i(r(6)),o=function(t){if(t&&t.__esModule)return t;var e={};if(null!=t)for(var r in t)Object.prototype.hasOwnProperty.call(t,r)&&(e[r]=t[r]);return e.default=t,e}(r(10));function i(t){return t&&t.__esModule?t:{default:t}}var u=4},function(t,e,r){t.exports=r(7).default},function(t,e,r){"use strict";e.__esModule=!0,e.default=function(t,e){if(t.whatToShow!==f)throw new Error(i);var r=0,o=t.referenceNode,s=null;if(l=e,!isNaN(parseInt(l))&&isFinite(l))s={forward:function(){return r<e},backward:function(){return r>e}};else{if(!function(t){return t.nodeType===c}(e))throw new Error(u);var d=function(t,e){if(t===e)return!1;var r=null,o=[t].concat((0,n.default)(t)).reverse(),i=[e].concat((0,n.default)(e)).reverse();for(;o[0]===i[0];)r=o.shift(),i.shift();o=o[0],i=i[0];var u=(0,a.default)(r.childNodes,o),f=(0,a.default)(r.childNodes,i);return u>f}(o,e)?function(){return!1}:function(){return o!==e};s={forward:d,backward:function(){return o!=e||!t.pointerBeforeReferenceNode}}}var l;for(;s.forward()&&null!==(o=t.nextNode());)r+=o.nodeValue.length;for(;s.backward()&&null!==(o=t.previousNode());)r-=o.nodeValue.length;return r};var n=o(r(8)),a=o(r(9));function o(t){return t&&t.__esModule?t:{default:t}}var i="Argument 1 of seek must use filter NodeFilter.SHOW_TEXT.",u="Argument 2 of seek must be a number or a Text Node.",f=4,c=3},function(t,e){function r(t){return!0}t.exports=function(t,e){var n=[];e=e||r;do{n.push(t),t=t.parentNode}while(t&&t.tagName&&e(t));return n.slice(1)}},function(t,e,r){"use strict";
/*!
 * index-of <https://github.com/jonschlinkert/index-of>
 *
 * Copyright (c) 2014-2015 Jon Schlinkert.
 * Licensed under the MIT license.
 */t.exports=function(t,e,r){r=r||0;if(null==t)return-1;var n=t.length,a=r<0?n+r:r;if(a>=t.length)return-1;for(;a<n;){if(t[a]===e)return a;a++}return-1}},function(t,e,r){t.exports=r(11)},function(t,e,r){"use strict";e.__esModule=!0,e.fromNode=function(t){var e=arguments.length<=1||void 0===arguments[1]?null:arguments[1];if(void 0===t)throw new Error('missing required parameter "node"');e=e||(0,n.default)(t);var r="/";for(;t!==e;){if(!t){throw new a.default("The supplied node is not contained by the root node.","InvalidNodeTypeError")}r="/"+f(t)+"["+c(t)+"]"+r,t=t.parentNode}return r.replace(/\/$/,"")},e.toNode=function(t,e){var r=arguments.length<=2||void 0===arguments[2]?null:arguments[2];if(void 0===t)throw new Error('missing required parameter "path"');if(void 0===e)throw new Error('missing required parameter "root"');var a=(0,n.default)(e);e!==a&&(t=t.replace(/^\//,"./"));var o=a.documentElement;null===r&&o.lookupNamespaceURI&&(f=o.lookupNamespaceURI(null)||u,r=function(t){var e={_default_:f};return e[t]||o.lookupNamespaceURI(t)});var f;return function(t,e,r){try{var a=t.replace(/\/(?!\.)([^\/:\(]+)(?=\/|$)/g,"/_default_:$1");return function(t,e,r){return(0,n.default)(e).evaluate(t,e,r,i,null).singleNodeValue}(a,e,r)}catch(r){return function(t,e){var r=t.split("/"),n=e;for(;n;){var a=r.shift();if(void 0===a)break;if("."!==a){var o=a.split(/[\[\]]/),i=o[0],u=o[1];i=i.replace("_default_:",""),u=u?parseInt(u):1,n=s(n,i,u)}}return n}(t,e)}}(t,e,r)};var n=o(r(1)),a=o(r(12));function o(t){return t&&t.__esModule?t:{default:t}}var i=9,u="http://www.w3.org/1999/xhtml";function f(t){switch(t.nodeName){case"#text":return"text()";case"#comment":return"comment()";case"#cdata-section":return"cdata-section()";default:return t.nodeName.toLowerCase()}}function c(t){for(var e=t.nodeName,r=1;t=t.previousSibling;)t.nodeName===e&&(r+=1);return r}function s(t,e,r){for(t=t.firstChild;t&&(f(t)!==e||0!=--r);t=t.nextSibling);return t}},function(t,e,r){"use strict";e.__esModule=!0;var n=function t(e,r){!function(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}(this,t),this.message=e,this.name=r,this.stack=(new Error).stack};e.default=n,(n.prototype=new Error).toString=function(){return this.name+": "+this.message}},function(t,e,r){"use strict";function n(t){return function(t){if(Array.isArray(t)){for(var e=0,r=new Array(t.length);e<t.length;e++)r[e]=t[e];return r}}(t)||function(t){if(Symbol.iterator in Object(t)||"[object Arguments]"===Object.prototype.toString.call(t))return Array.from(t)}(t)||function(){throw new TypeError("Invalid attempt to spread non-iterable instance")}()}function a(t,e){return function(t){if(Array.isArray(t))return t}(t)||function(t,e){var r=[],n=!0,a=!1,o=void 0;try{for(var i,u=t[Symbol.iterator]();!(n=(i=u.next()).done)&&(r.push(i.value),!e||r.length!==e);n=!0);}catch(t){a=!0,o=t}finally{try{n||null==u.return||u.return()}finally{if(a)throw o}}return r}(t,e)||function(){throw new TypeError("Invalid attempt to destructure non-iterable instance")}()}Object.defineProperty(e,"__esModule",{value:!0});var o=r(0),i=new Set(["address","article","aside","blockquote","details","dialog","dd","div","dl","dt","fieldset","figcaption","figure","footer","form","h1","h2","h3","h4","h5","h6","header","hgroup","hr","li","main","nav","ol","p","pre","section","table","ul"]);function u(t,e){var r=t.annotation.type,n=e.annotation.type,a=t.tagName.toLowerCase(),o=e.tagName.toLowerCase();if("p"===a)return-1;if("p"===o)return 1;if(r!==n){if("highlight"===r)return 1;if("highlight"===n)return-1}return i.has(a)?-1:i.has(o)?1:-1}function f(t,e){return t.start===e.start?t.end<e.end?1:-1:t.start<e.start?-1:1}function c(t,e){return{start:t,end:e,type:"markup",meta:{htmlTagName:"p",htmlClassName:"auto-para-break"}}}var s={font:"font-family",fontSize:"font-size",color:"color",bgColor:"background-color",opacity:"opacity"};function d(t){var e=Object.keys(t).map(function(e){var r=t[e],n=s[e]||e;return"".concat(n,": ").concat(r)});return e.length?e.join("; ")+";":""}function l(t){var e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"span";return t.meta&&t.meta.htmlTagName?t.meta.htmlTagName.toLowerCase():e.toLowerCase()}function p(t,e,r){var n=l(t),o=[],i=function(t){var e=t.format;switch(t.type){case"redaction":return Object.assign({"white-space":"pre-wrap","word-break":"break-word"},e);default:return Object.assign({},e)}}(t);i&&(d(i)&&o.push(["style",d(i)]));t.meta&&t.meta.id&&o.push(["id",t.meta.id]);var u=["sharpie-annotation","sharpie-type-".concat(t.type)];t.meta&&t.meta.htmlClassName&&u.push(t.meta.htmlClassName),o.push(["class",u.join(" ")]);var f=g(e,r),c=o.map(function(t){var e=a(t,2),r=e[0],n=e[1];return"".concat(r,'="').concat(n,'"')}).join(" ");return"<".concat(n," ").concat(f).concat(c?" "+c:"",">")}function h(t,e){var r=l(t,e);return"</".concat(r,">")}function v(t,e,r){for(var n=(t=t||"").length,a=Math.max(n,e),o=e-n,i=o>>1,u=o-i,f=new Array(a),c=0,s=0;s<i;s++)f[c++]=r;for(var d=0;d<n;d++)f[c++]=t[d];for(var l=0;l<u;l++)f[c++]=r;return f}function g(t,e){return"__metadata_".concat(t,"_").concat(e,"__")}function m(t,e,r){var s=[];(r=o.defaults(r,{autoParagraph:!0})).autoParagraph&&(o._debug("Generating HTML paragraph break annotations"),s=function(t){for(var e=[],r=/\n/g,n=0,a=null;null!==(a=r.exec(t));)e.push(c(n,a.index)),n=a.index;return e.push(c(n,t.length)),e}(t));var d=new WeakMap,m=new WeakMap;e.forEach(function(t,e){return d.set(t,"".concat(e))}),s.forEach(function(t,e){return d.set(t,"inferred-".concat(e))});for(var w,y,b,_,N=[].concat(n(e),n(s)).sort(f),x=[],O=[],S=[],M=[],j=new Map,k="",E=0;E<=t.length;E++){for(;O.length>0&&O[0].end===E;)for(var T=O[0];x.length>0;){var C=x.shift();k+=h(C.annotation),j.get(g(C.id,C.part)).end=E;for(var P=0;P<O.length;){var I=O[P];if(I.end>E)break;I===C.annotation?O.splice(P,1):P++}if(T===C.annotation)break;C.annotation.end>E&&S.unshift({annotation:C.annotation,id:C.id,part:C.part+1,start:E,end:-1,outputOffsetPos:-1,warp:-1})}for(var A=[];N.length>0&&N[0].start===E;){var R=N.shift();if(R.end<=R.start)o._debug("Ignoring invalid annotation range",R.start,R.end);else{for(var L=l(R),q=-1,F=x.length-1;F>=0;F--)if(w=x[F].annotation,y=R,b=void 0,_=void 0,b=l(w),_=l(y),!(i.has(_)&&!i.has(b)?(o._debug("Forcing inline reopen:",b,"cannot contain",_),0):"redaction"!==y.type||"highlight"!==w.type||(o._debug("Forcing highlight reopen: containing redaction"),0))){q=F;break}for(var D=0;D<=q;D++){var H=x.shift();k+=h(H.annotation),j.get(g(H.id,H.part)).end=E,S.unshift({annotation:H.annotation,id:H.id,part:H.part+1,start:E,end:-1,outputOffsetPos:-1,warp:-1}),D++}var W=1,z=void 0;if("redaction"===R.type){var B=R.end-R.start,U=R.extent?R.extent:Math.max(B,(R.content||"").length);z={redaction:R,output:v(R.content,U,"&nbsp;"),extent:U,cursor:0},W=B/U}m.set(R,W),A.push({annotation:R,tagName:L,redaction:z,part:0})}}for(;S.length>0;){var V=S.shift();A.push({annotation:V.annotation,tagName:l(V.annotation),part:V.part})}for(A.sort(u);A.length>0;){var $=A.shift(),G=$.annotation;0===$.part&&(o.sortedInsert(O,G,function(t){return t.end}),$.redaction&&M.unshift($.redaction));var X={annotation:G,id:d.get(G),part:$.part,start:E,end:-1,warp:m.get(G),outputOffsetPos:k.length};k+=p(G,d.get(G),$.part);var J=g(X.id,X.part);j.has(J)&&o._error("Overwriting node metadata",J),j.set(J,X),x.unshift(X)}for(;M.length&&M[0].redaction.end===E;)M.shift();for(var K=0;K<M.length;K++){var Q=M[K],Y=Q.cursor,Z=(1+E-Q.redaction.start)/(Q.redaction.end-Q.redaction.start)*Q.extent;Q.cursor=Math.floor(Z);for(var tt=0===K&&Q.cursor>Y;tt&&Y<Q.cursor;)k+=Q.output[Y++]}0===M.length&&(k+=t[E]||"")}return function(t,e){var r=!0,n=!1,o=void 0;try{for(var i,u=e[Symbol.iterator]();!(r=(i=u.next()).done);r=!0){var f=a(i.value,2),c=f[0],s=f[1],d=['data-sharpie-start="'.concat(s.start,'"'),'data-sharpie-end="'.concat(s.end,'"'),'data-sharpie-warp="'.concat(s.warp,'"'),'data-sharpie-id="'.concat(s.id,'"')].join(" "),l=t.substring(0,s.outputOffsetPos),p=t.substring(s.outputOffsetPos).replace(c,d);t=l+p}}catch(t){n=!0,o=t}finally{try{r||null==u.return||u.return()}finally{if(n)throw o}}return t}(k,j)}e.renderToString=m,e.render=function(t,e,r){var n=Date.now(),a=m(e,r);o._debug("Rendered in",Date.now()-n,"ms"),t.innerHTML=a}}])});