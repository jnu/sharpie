!function(t,e){"object"==typeof exports&&"object"==typeof module?module.exports=e():"function"==typeof define&&define.amd?define([],e):"object"==typeof exports?exports.Sharpie=e():t.Sharpie=e()}(window,function(){return function(t){var e={};function n(r){if(e[r])return e[r].exports;var a=e[r]={i:r,l:!1,exports:{}};return t[r].call(a.exports,a,a.exports,n),a.l=!0,a.exports}return n.m=t,n.c=e,n.d=function(t,e,r){n.o(t,e)||Object.defineProperty(t,e,{enumerable:!0,get:r})},n.r=function(t){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(t,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(t,"__esModule",{value:!0})},n.t=function(t,e){if(1&e&&(t=n(t)),8&e)return t;if(4&e&&"object"==typeof t&&t&&t.__esModule)return t;var r=Object.create(null);if(n.r(r),Object.defineProperty(r,"default",{enumerable:!0,value:t}),2&e&&"string"!=typeof t)for(var a in t)n.d(r,a,function(e){return t[e]}.bind(null,a));return r},n.n=function(t){var e=t&&t.__esModule?function(){return t.default}:function(){return t};return n.d(e,"a",e),e},n.o=function(t,e){return Object.prototype.hasOwnProperty.call(t,e)},n.p="",n(n.s=1)}([function(t,e,n){"use strict";Object.defineProperty(e,"__esModule",{value:!0}),e._debug=function(){},e._error=function(){},e.defaults=function(t,e){return t?Object.assign({},e,t):Object.assign({},e)},e.identity=function(t){return t},e.sortedInsert=function(t,n){var r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:e.identity,a=r(n);if(0!==t.length){for(var o=0,i=t.length;i-o>1;){var u=o+(i-o>>1),s=r(t[u]);a<s?i=u:o=u}var c=a<=r(t[o])?o:i;t.splice(c,0,n)}else t.push(n)}},function(t,e,n){"use strict";Object.defineProperty(e,"__esModule",{value:!0});var r=n(2);e.clearSelection=r.clearSelection,e.watch=r.watch,e.unwatch=r.unwatch;var a=n(3);e.renderHTML=a.render,e.renderToString=a.renderToString},function(t,e,n){"use strict";Object.defineProperty(e,"__esModule",{value:!0});var r=n(0),a=new Map;function o(t,e){var n=!0,r=!1,o=void 0;try{for(var i,u=a.keys()[Symbol.iterator]();!(n=(i=u.next()).done);n=!0){var s=i.value;if(s.contains(e))return a.get(s).get(t)}}catch(t){r=!0,o=t}finally{try{n||null==u.return||u.return()}finally{if(r)throw o}}}function i(t){var e=function(t){for(var e=t,n=document.body;e&&e!==n;){if(e.dataset&&e.dataset.hasOwnProperty("sharpieStart"))return e;e=e.parentElement}}(t),n=function(t){for(var e=t;e;){if(e.dataset&&e.dataset.hasOwnProperty("sharpieStart"))return e;e=e.previousElementSibling}}(t),r=n?n.dataset.sharpieEnd:e.dataset.sharpieStart,a=e.dataset.sharpieWarp;return{pos:+r,warp:a?+a:1}}function u(t){var e=i(t.startContainer),n=i(t.endContainer),r=e.pos+t.startOffset*e.warp,a=n.pos+t.endOffset*n.warp;return[Math.floor(r),Math.ceil(a)]}function s(t){var e=window.getSelection();if(e.isCollapsed)r._debug("Ignoring collapsed selection");else{var n=function(t,e){var n=o(t,e.anchorNode);if(n){var a=o(t,e.focusNode);if(a){if(n===a)return n;r._debug("Selection spans multiple watched containers")}else r._debug("Selection ends outside of watched container")}else r._debug("Selection starts outside of watched container")}("select",e);if(n)for(var a=0;a<e.rangeCount;a++){var i=e.getRangeAt(a);if(i.collapsed)r._debug("Ignoring collapsed range");else{var s=u(i),c=!0,f=!1,l=void 0;try{for(var d,p=n[Symbol.iterator]();!(c=(d=p.next()).done);c=!0){(0,d.value)(s,t)}}catch(t){f=!0,l=t}finally{try{c||null==p.return||p.return()}finally{if(f)throw l}}}}else r._debug("Ignoring selection due to overflow")}}function c(t){return function(e){var n=e.target;if(n.classList.contains("sharpie-annotation")){var a=n.dataset.sharpieId;if(a){if("inferred-"!==a.substr(0,9)){var i=+a;if(i==i){var u=o(t,n),s=!0,c=!1,f=void 0;try{for(var l,d=u[Symbol.iterator]();!(s=(l=d.next()).done);s=!0){(0,l.value)(i,e)}}catch(t){c=!0,f=t}finally{try{s||null==d.return||d.return()}finally{if(c)throw f}}}else r._debug("Could not parse sharpie ID:",a)}}else r._debug("Sharpie ID not set on event target")}}}var f=c("hoverIn"),l=c("hoverOut"),d=!1;function p(t,e){return t.has(e)||t.set(e,new Set),t.get(e)}e.watch=function(t){d||(window.addEventListener("mouseup",s),window.addEventListener("mouseover",f),window.addEventListener("mouseout",l),d=!0),a.has(t)||a.set(t,new Map);var e=a.get(t),n={hoverIn:function(t){return p(e,"hoverIn").add(t),n},hoverOut:function(t){return p(e,"hoverOut").add(t),n},select:function(t){return p(e,"select").add(t),n}};return n},e.unwatch=function(t,e,n){var r=a.get(t);if(!r)return!1;if(n){var o=r.get(e);if(!o)return!1;var i=o.has(n);return o.delete(n),i}if(e){var u=r.has(e);return r.delete(e),u}return a.delete(t),!0},e.clearSelection=function(){if(window.getSelection){var t=window.getSelection();t.empty?t.empty():t.removeAllRanges&&t.removeAllRanges()}}},function(t,e,n){"use strict";function r(t){return function(t){if(Array.isArray(t)){for(var e=0,n=new Array(t.length);e<t.length;e++)n[e]=t[e];return n}}(t)||function(t){if(Symbol.iterator in Object(t)||"[object Arguments]"===Object.prototype.toString.call(t))return Array.from(t)}(t)||function(){throw new TypeError("Invalid attempt to spread non-iterable instance")}()}function a(t,e){return function(t){if(Array.isArray(t))return t}(t)||function(t,e){var n=[],r=!0,a=!1,o=void 0;try{for(var i,u=t[Symbol.iterator]();!(r=(i=u.next()).done)&&(n.push(i.value),!e||n.length!==e);r=!0);}catch(t){a=!0,o=t}finally{try{r||null==u.return||u.return()}finally{if(a)throw o}}return n}(t,e)||function(){throw new TypeError("Invalid attempt to destructure non-iterable instance")}()}Object.defineProperty(e,"__esModule",{value:!0});var o=n(0),i=new Set(["address","article","aside","blockquote","details","dialog","dd","div","dl","dt","fieldset","figcaption","figure","footer","form","h1","h2","h3","h4","h5","h6","header","hgroup","hr","li","main","nav","ol","p","pre","section","table","ul"]);function u(t,e){var n=t.annotation.type,r=e.annotation.type,a=t.tagName.toLowerCase(),o=e.tagName.toLowerCase();if("p"===a)return-1;if("p"===o)return 1;if(n!==r){if("highlight"===n)return 1;if("highlight"===r)return-1}return i.has(a)?-1:i.has(o)?1:-1}function s(t,e){return t.start===e.start?t.end<e.end?1:-1:t.start<e.start?-1:1}function c(t,e,n){return{start:t,end:e,type:"markup",meta:{htmlTagName:"p",htmlClassName:n?"auto-para-break":void 0}}}var f={font:"font-family",fontSize:"font-size",color:"color",bgColor:"background-color",opacity:"opacity"};function l(t){var e=Object.keys(t).map(function(e){var n=t[e],r=f[e]||e;return"".concat(r,": ").concat(n)});return e.length?e.join("; ")+";":""}function d(t){var e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"span";return t.meta&&t.meta.htmlTagName?t.meta.htmlTagName.toLowerCase():e.toLowerCase()}function p(t,e,n,r){var o=d(t),i=[],u=function(t){var e=t.format;switch(t.type){case"redaction":return Object.assign({"white-space":"pre-wrap","word-break":"break-word"},e);default:return Object.assign({},e)}}(t);u&&(l(u)&&i.push(["style",l(u)]));t.meta&&t.meta.id&&i.push(["id",t.meta.id]);var s=r.simpleHTML?[]:["sharpie-annotation","sharpie-type-".concat(t.type)];t.meta&&t.meta.htmlClassName&&s.push(t.meta.htmlClassName),s.length&&i.push(["class",s.join(" ")]);var c=r.simpleHTML?"":" ".concat(g(e,n)),f=i.map(function(t){var e=a(t,2),n=e[0],r=e[1];return"".concat(n,'="').concat(r,'"')}).join(" "),p=f?" ".concat(f):"";return"<".concat(o).concat(c).concat(p,">")}function h(t,e){var n=d(t,e);return"</".concat(n,">")}function v(t,e,n){for(var r=(t=t||"").length,a=Math.max(r,e),o=e-r,i=o>>1,u=o-i,s=new Array(a),c=0,f=0;f<i;f++)s[c++]=n;for(var l=0;l<r;l++)s[c++]=t[l];for(var d=0;d<u;d++)s[c++]=n;return s}function g(t,e){return"__metadata_".concat(t,"_").concat(e,"__")}function y(t,e,n){if(null==t)return o._debug("Input missing, bailing out of render"),"";var f=[];(n=o.defaults(n,{autoParagraph:!0,simpleHTML:!1})).autoParagraph&&(o._debug("Generating HTML paragraph break annotations"),f=function(t,e){for(var n=[],r=/\n/g,a=0,o=null;null!==(o=r.exec(t));)n.push(c(a,o.index,!e.simpleHTML)),a=o.index;return n.push(c(a,t.length,!e.simpleHTML)),n}(t,n));var l=new WeakMap,y=new WeakMap;e.forEach(function(t,e){return l.set(t,"".concat(e))}),f.forEach(function(t,e){return l.set(t,"inferred-".concat(e))});for(var m,b,w,_,S=[].concat(r(e),r(f)).sort(s),O=[],M=[],j=[],x=[],T=new Map,P="",L=0;L<=t.length;L++){for(;M.length>0&&M[0].end===L;)for(var I=M[0];O.length>0;){var k=O.shift();P+=h(k.annotation),T.get(g(k.id,k.part)).end=L;for(var C=0;C<M.length;){var N=M[C];if(N.end>L)break;N===k.annotation?M.splice(C,1):C++}if(I===k.annotation)break;k.annotation.end>L&&j.unshift({annotation:k.annotation,id:k.id,part:k.part+1,start:L,end:-1,outputOffsetPos:-1,warp:-1})}for(var A=[];S.length>0&&S[0].start===L;){var E=S.shift();if(E.end<=E.start)o._debug("Ignoring invalid annotation range",E.start,E.end);else{for(var H=d(E),D=-1,R=O.length-1;R>=0;R--)if(m=O[R].annotation,b=E,w=void 0,_=void 0,w=d(m),_=d(b),!(i.has(_)&&!i.has(w)?(o._debug("Forcing inline reopen:",w,"cannot contain",_),0):"redaction"!==b.type||"highlight"!==m.type||(o._debug("Forcing highlight reopen: containing redaction"),0))){D=R;break}for(var W=0;W<=D;W++){var z=O.shift();P+=h(z.annotation),T.get(g(z.id,z.part)).end=L,j.unshift({annotation:z.annotation,id:z.id,part:z.part+1,start:L,end:-1,outputOffsetPos:-1,warp:-1}),W++}var F=1,q=void 0;if("redaction"===E.type){var G=E.end-E.start,B=E.extent?E.extent:Math.max(G,(E.content||"").length);q={redaction:E,output:v(E.content,B,"&nbsp;"),extent:B,cursor:0},F=G/B}y.set(E,F),A.push({annotation:E,tagName:H,redaction:q,part:0})}}for(;j.length>0;){var J=j.shift();A.push({annotation:J.annotation,tagName:d(J.annotation),part:J.part})}for(A.sort(u);A.length>0;){var K=A.shift(),Q=K.annotation;0===K.part&&(o.sortedInsert(M,Q,function(t){return t.end}),K.redaction&&x.unshift(K.redaction));var U={annotation:Q,id:l.get(Q),part:K.part,start:L,end:-1,warp:y.get(Q),outputOffsetPos:P.length};P+=p(Q,l.get(Q),K.part,n);var V=g(U.id,U.part);T.has(V)&&o._error("Overwriting node metadata",V),T.set(V,U),O.unshift(U)}for(;x.length&&x[0].redaction.end===L;)x.shift();for(var X=0;X<x.length;X++){var Y=x[X],Z=Y.cursor,$=(1+L-Y.redaction.start)/(Y.redaction.end-Y.redaction.start)*Y.extent;Y.cursor=Math.floor($);for(var tt=0===X&&Y.cursor>Z;tt&&Z<Y.cursor;)P+=Y.output[Z++]}0===x.length&&(P+=t[L]||"")}return n.simpleHTML?P:function(t,e){var n=!0,r=!1,o=void 0;try{for(var i,u=e[Symbol.iterator]();!(n=(i=u.next()).done);n=!0){var s=a(i.value,2),c=s[0],f=s[1],l=['data-sharpie-start="'.concat(f.start,'"'),'data-sharpie-end="'.concat(f.end,'"'),'data-sharpie-warp="'.concat(f.warp,'"'),'data-sharpie-id="'.concat(f.id,'"')].join(" "),d=t.substring(0,f.outputOffsetPos),p=t.substring(f.outputOffsetPos).replace(c,l);t=d+p}}catch(t){r=!0,o=t}finally{try{n||null==u.return||u.return()}finally{if(r)throw o}}return t}(P,T)}e.renderToString=y,e.render=function(t,e,n){var r=Date.now(),a=y(e,n);o._debug("Rendered in",Date.now()-r,"ms"),t.innerHTML=a}}])});