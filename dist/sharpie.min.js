!function(t,e){"object"==typeof exports&&"object"==typeof module?module.exports=e():"function"==typeof define&&define.amd?define([],e):"object"==typeof exports?exports.Sharpie=e():t.Sharpie=e()}(window,function(){return function(t){var e={};function n(r){if(e[r])return e[r].exports;var a=e[r]={i:r,l:!1,exports:{}};return t[r].call(a.exports,a,a.exports,n),a.l=!0,a.exports}return n.m=t,n.c=e,n.d=function(t,e,r){n.o(t,e)||Object.defineProperty(t,e,{enumerable:!0,get:r})},n.r=function(t){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(t,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(t,"__esModule",{value:!0})},n.t=function(t,e){if(1&e&&(t=n(t)),8&e)return t;if(4&e&&"object"==typeof t&&t&&t.__esModule)return t;var r=Object.create(null);if(n.r(r),Object.defineProperty(r,"default",{enumerable:!0,value:t}),2&e&&"string"!=typeof t)for(var a in t)n.d(r,a,function(e){return t[e]}.bind(null,a));return r},n.n=function(t){var e=t&&t.__esModule?function(){return t.default}:function(){return t};return n.d(e,"a",e),e},n.o=function(t,e){return Object.prototype.hasOwnProperty.call(t,e)},n.p="",n(n.s=1)}([function(t,e,n){"use strict";Object.defineProperty(e,"__esModule",{value:!0}),e._debug=function(){},e._error=function(){},e.defaults=function(t,e){return t?Object.assign({},e,t):Object.assign({},e)},e.identity=function(t){return t},e.sortedInsert=function(t,n){var r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:e.identity,a=r(n);if(0!==t.length){for(var o=0,i=t.length;i-o>1;){var u=o+(i-o>>1),c=r(t[u]);a<c?i=u:o=u}var s=a<=r(t[o])?o:i;t.splice(s,0,n)}else t.push(n)}},function(t,e,n){"use strict";Object.defineProperty(e,"__esModule",{value:!0});var r=n(2);e.watch=r.watch,e.unwatch=r.unwatch;var a=n(3);e.renderHTML=a.render,e.renderToString=a.renderToString},function(t,e,n){"use strict";Object.defineProperty(e,"__esModule",{value:!0});var r=n(0),a=new Map;function o(t){var e=!0,n=!1,r=void 0;try{for(var o,i=a.keys()[Symbol.iterator]();!(e=(o=i.next()).done);e=!0){var u=o.value;if(u.contains(t))return a.get(u)}}catch(t){n=!0,r=t}finally{try{e||null==i.return||i.return()}finally{if(n)throw r}}}function i(t){var e=function(t){for(var e=t,n=document.body;e&&e!==n;){if(e.dataset&&e.dataset.hasOwnProperty("sharpieStart"))return e;e=e.parentElement}}(t),n=function(t){for(var e=t;e;){if(e.dataset&&e.dataset.hasOwnProperty("sharpieStart"))return e;e=e.previousElementSibling}}(t),r=n?n.dataset.sharpieEnd:e.dataset.sharpieStart,a=e.dataset.sharpieWarp;return{pos:+r,warp:a?+a:1}}function u(t){var e=i(t.startContainer),n=i(t.endContainer),r=e.pos+t.startOffset*e.warp,a=n.pos+t.endOffset*n.warp;return[Math.floor(r),Math.ceil(a)]}function c(){var t=window.getSelection();if(t.isCollapsed)r._debug("Ignoring collapsed selection");else{var e=function(t){var e=o(t.anchorNode);if(e){var n=o(t.focusNode);if(n){if(e===n)return e;r._debug("Selection spans multiple watched containers")}else r._debug("Selection ends outside of watched container")}else r._debug("Selection starts outside of watched container")}(t);if(e)for(var n=0;n<t.rangeCount;n++){var a=t.getRangeAt(n);if(a.collapsed)r._debug("Ignoring collapsed range");else{var i=u(a),c=!0,s=!1,f=void 0;try{for(var d,l=e[Symbol.iterator]();!(c=(d=l.next()).done);c=!0){(0,d.value)(i)}}catch(t){s=!0,f=t}finally{try{c||null==l.return||l.return()}finally{if(s)throw f}}}}else r._debug("Ignoring selection due to overflow")}}var s=!1;e.watch=function(t,e){s||(window.addEventListener("mouseup",c),s=!0),a.has(t)||a.set(t,new Set),a.get(t).add(e)},e.unwatch=function(t,e){if(e){var n=a.get(t);return!!n&&!!n.has(e)&&(n.delete(e),!0)}return!!a.has(t)&&(a.delete(t),!0)}},function(t,e,n){"use strict";function r(t){return function(t){if(Array.isArray(t)){for(var e=0,n=new Array(t.length);e<t.length;e++)n[e]=t[e];return n}}(t)||function(t){if(Symbol.iterator in Object(t)||"[object Arguments]"===Object.prototype.toString.call(t))return Array.from(t)}(t)||function(){throw new TypeError("Invalid attempt to spread non-iterable instance")}()}function a(t,e){return function(t){if(Array.isArray(t))return t}(t)||function(t,e){var n=[],r=!0,a=!1,o=void 0;try{for(var i,u=t[Symbol.iterator]();!(r=(i=u.next()).done)&&(n.push(i.value),!e||n.length!==e);r=!0);}catch(t){a=!0,o=t}finally{try{r||null==u.return||u.return()}finally{if(a)throw o}}return n}(t,e)||function(){throw new TypeError("Invalid attempt to destructure non-iterable instance")}()}Object.defineProperty(e,"__esModule",{value:!0});var o=n(0),i=new Set(["address","article","aside","blockquote","details","dialog","dd","div","dl","dt","fieldset","figcaption","figure","footer","form","h1","h2","h3","h4","h5","h6","header","hgroup","hr","li","main","nav","ol","p","pre","section","table","ul"]);function u(t,e){var n=t.annotation.type,r=e.annotation.type,a=t.tagName.toLowerCase(),o=e.tagName.toLowerCase();if("p"===a)return-1;if("p"===o)return 1;if(n!==r){if("highlight"===n)return 1;if("highlight"===r)return-1}return i.has(a)?-1:i.has(o)?1:-1}function c(t,e){return t.start===e.start?t.end<e.end?1:-1:t.start<e.start?-1:1}function s(t,e){return{start:t,end:e,type:"markup",meta:{htmlTagName:"p",htmlClassName:"auto-para-break"}}}var f={font:"font-family",fontSize:"font-size",color:"color",bgColor:"background-color",opacity:"opacity"};function d(t){var e=Object.keys(t).map(function(e){var n=t[e],r=f[e]||e;return"".concat(r,": ").concat(n)});return e.length?e.join("; ")+";":""}function l(t){var e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"span";return t.meta&&t.meta.htmlTagName?t.meta.htmlTagName.toLowerCase():e.toLowerCase()}function p(t,e,n){var r=l(t),o=[],i=function(t){var e=t.format;switch(t.type){case"redaction":return Object.assign({"white-space":"pre-wrap","word-break":"break-word"},e);default:return Object.assign({},e)}}(t);i&&(d(i)&&o.push(["style",d(i)]));t.meta&&t.meta.id&&o.push(["id",t.meta.id]);var u=["sharpie-annotation","sharpie-type-".concat(t.type)];t.meta&&t.meta.htmlClassName&&u.push(t.meta.htmlClassName),o.push(["class",u.join(" ")]);var c=v(e,n),s=o.map(function(t){var e=a(t,2),n=e[0],r=e[1];return"".concat(n,'="').concat(r,'"')}).join(" ");return"<".concat(r," ").concat(c).concat(s?" "+s:"",">")}function h(t,e){var n=l(t,e);return"</".concat(n,">")}function g(t,e,n){for(var r=(t=t||"").length,a=Math.max(r,e),o=e-r,i=o>>1,u=o-i,c=new Array(a),s=0,f=0;f<i;f++)c[s++]=n;for(var d=0;d<r;d++)c[s++]=t[d];for(var l=0;l<u;l++)c[s++]=n;return c}function v(t,e){return"__metadata_".concat(t,"_").concat(e,"__")}function y(t,e,n){var f=[];(n=o.defaults(n,{autoParagraph:!0})).autoParagraph&&(o._debug("Generating HTML paragraph break annotations"),f=function(t){for(var e=[],n=/\n/g,r=0,a=null;null!==(a=n.exec(t));)e.push(s(r,a.index)),r=a.index;return e.push(s(r,t.length)),e}(t));var d=new WeakMap,y=new WeakMap;e.forEach(function(t,e){return d.set(t,"".concat(e))}),f.forEach(function(t,e){return d.set(t,"inferred-".concat(e))});for(var b,m,w,_,O=[].concat(r(e),r(f)).sort(c),S=[],j=[],x=[],M=[],P=new Map,k="",T=0;T<=t.length;T++){for(;j.length>0&&j[0].end===T;)for(var C=j[0];S.length>0;){var N=S.shift();k+=h(N.annotation),P.get(v(N.id,N.part)).end=T;for(var A=0;A<j.length;){var E=j[A];if(E.end>T)break;E===N.annotation?j.splice(A,1):A++}if(C===N.annotation)break;N.annotation.end>T&&x.unshift({annotation:N.annotation,id:N.id,part:N.part+1,start:T,end:-1,outputOffsetPos:-1,warp:-1})}for(var I=[];O.length>0&&O[0].start===T;){var L=O.shift();if(L.end<=L.start)o._debug("Ignoring invalid annotation range",L.start,L.end);else{for(var H=l(L),W=-1,z=S.length-1;z>=0;z--)if(b=S[z].annotation,m=L,w=void 0,_=void 0,w=l(b),_=l(m),!(i.has(_)&&!i.has(w)?(o._debug("Forcing inline reopen:",w,"cannot contain",_),0):"redaction"!==m.type||"highlight"!==b.type||(o._debug("Forcing highlight reopen: containing redaction"),0))){W=z;break}for(var D=0;D<=W;D++){var F=S.shift();k+=h(F.annotation),P.get(v(F.id,F.part)).end=T,x.unshift({annotation:F.annotation,id:F.id,part:F.part+1,start:T,end:-1,outputOffsetPos:-1,warp:-1}),D++}var R=1,q=void 0;if("redaction"===L.type){var G=L.end-L.start,B=L.extent?L.extent:Math.max(G,(L.content||"").length);q={redaction:L,output:g(L.content,B,"&nbsp;"),extent:B,cursor:0},R=G/B}y.set(L,R),I.push({annotation:L,tagName:H,redaction:q,part:0})}}for(;x.length>0;){var J=x.shift();I.push({annotation:J.annotation,tagName:l(J.annotation),part:J.part})}for(I.sort(u);I.length>0;){var K=I.shift(),Q=K.annotation;0===K.part&&(o.sortedInsert(j,Q,function(t){return t.end}),K.redaction&&M.unshift(K.redaction));var U={annotation:Q,id:d.get(Q),part:K.part,start:T,end:-1,warp:y.get(Q),outputOffsetPos:k.length};k+=p(Q,d.get(Q),K.part);var V=v(U.id,U.part);P.has(V)&&o._error("Overwriting node metadata",V),P.set(V,U),S.unshift(U)}for(;M.length&&M[0].redaction.end===T;)M.shift();for(var X=0;X<M.length;X++){var Y=M[X],Z=Y.cursor,$=(1+T-Y.redaction.start)/(Y.redaction.end-Y.redaction.start)*Y.extent;Y.cursor=Math.floor($);for(var tt=0===X&&Y.cursor>Z;tt&&Z<Y.cursor;)k+=Y.output[Z++]}0===M.length&&(k+=t[T]||"")}return function(t,e){var n=!0,r=!1,o=void 0;try{for(var i,u=e[Symbol.iterator]();!(n=(i=u.next()).done);n=!0){var c=a(i.value,2),s=c[0],f=c[1],d=['data-sharpie-start="'.concat(f.start,'"'),'data-sharpie-end="'.concat(f.end,'"'),'data-sharpie-warp="'.concat(f.warp,'"'),'data-sharpie-id="'.concat(f.id,'"')].join(" "),l=t.substring(0,f.outputOffsetPos),p=t.substring(f.outputOffsetPos).replace(s,d);t=l+p}}catch(t){r=!0,o=t}finally{try{n||null==u.return||u.return()}finally{if(r)throw o}}return t}(k,P)}e.renderToString=y,e.render=function(t,e,n){var r=Date.now(),a=y(e,n);o._debug("Rendered in",Date.now()-r,"ms"),t.innerHTML=a}}])});